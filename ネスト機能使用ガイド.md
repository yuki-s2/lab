# 📋 ネスト機能使用ガイド

## 🎯 機能概要

table内にtableをネストして複雑なレイアウトを作成し、Supabaseに保存できます。

## 🚀 使用方法

### 1. **Supabaseデータベース設定**

```sql
-- add_parent_id_migration.sql をSupabase Dashboard > SQL Editorで実行
ALTER TABLE parts
ADD COLUMN IF NOT EXISTS parent_id INTEGER REFERENCES parts(id) ON DELETE CASCADE;

CREATE INDEX IF NOT EXISTS idx_parts_parent_id ON parts(parent_id);
```

### 2. **基本操作**

#### **パーツの作成**

1. 右側のフレーム一覧から「📋 シンプルテーブルフレーム」をクリック
2. 「📋 作成と同時にis-worksに追加する」にチェック
3. フレーム名とコンテンツを入力して「追加」

#### **ネスト操作**

1. **ドラッグ開始**: パーツをドラッグすると他のパーツのドロップエリアが拡大
2. **ネストエリアにドロップ**: 青い境界線の「📁 ネストエリア」にドロップ
3. **空エリアにドロップ**: 「📋 ここにパーツをドロップ」エリアにドロップ

### 3. **視覚的フィードバック**

#### **通常状態**

- 薄いグレーの境界線
- 小さめのドロップエリア

#### **重なり検知時**

- **ドロップエリア拡大**: 1.03〜1.08倍
- **アイコン変更**: 📋 → 🎯
- **色変化**: 青系の強調色
- **メッセージ更新**: 具体的な操作指示

#### **ドラッグオーバー時**

- さらに拡大（1.1倍）
- 濃い青の境界線
- シャドウ効果

### 4. **保存とHTML生成**

#### **保存**

- ネスト構造は自動的にparent_idとorder_indexで管理
- 「保存する」ボタンでSupabaseに永続化
- コンソールに保存統計を表示

#### **HTML生成**

- 「HTML」ボタンでネスト構造を考慮したHTMLを生成
- 子パーツは親の{{content}}内に再帰的に配置
- 「📋 copy」でクリップボードにコピー

## 🔧 技術仕様

### **データ構造**

```typescript
interface Part {
  id: number;
  name: string;
  content: string | null;
  frame: string;
  frame_id: number;
  order_index: number;
  parent_id?: number | null; // ネスト用
  children?: Part[]; // クライアント側のみ
}
```

### **Supabaseテーブル**

```sql
parts (
  id: integer PRIMARY KEY,
  name: text,
  content: text,
  frame: text,
  frame_id: integer,
  order_index: integer,
  parent_id: integer REFERENCES parts(id),
  uid: text,
  created_at: timestamp,
  updated_at: timestamp
)
```

## 🎨 UX特徴

1. **リアルタイム視覚フィードバック**
   - ドラッグ中のアイテム拡大表示
   - 重なり検知での自動エリア拡大

2. **直感的操作**
   - ドロップ可能エリアの明確な表示
   - 段階的な視覚変化

3. **エラー防止**
   - 無効な操作の視覚的ブロック
   - 明確な操作ガイダンス

## 🐛 トラブルシューティング

### **パーツが表示されない**

- ブラウザのコンソールで復元ログを確認
- Supabaseのpartsテーブルでparent_idが正しく設定されているか確認

### **ドラッグが効かない**

- DnDライブラリの競合確認
- コンソールエラーの確認

### **保存されない**

- ネットワーク接続確認
- Supabaseの認証状態確認
- コンソールの保存ログ確認

## 📊 デバッグ情報

### **ブラウザコンソール**

```
📖 Supabaseからネスト構造復元: { 元データ数, トップレベル数, 子パーツ数 }
💾 ネスト構造保存データ: [{ id, order_index, parent_id }]
📊 保存サマリー: { トップレベルパーツ数, 子パーツ数 }
```

---

**🎉 完了！** ネストした複雑なHTMLメール構造を簡単に作成・管理できます。
